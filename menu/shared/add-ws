#!/bin/bash
clear
red() { echo -e "\\033[32;1m${*}\\033[0m"; }

CITY=$(cat /etc/xray/city)
domain=$(cat /etc/xray/domain)

# === [Tambahan: deteksi hostname dan set anchor/pattern/path] ===
nama=$(hostname)
case "$nama" in
  hemat)
    anchor="#hemat$"; prefix="##1"
    base_path="/watch"
    sub_category="anime"
    ;;
  troy5)
    anchor="#troy5$"; prefix="##2"
    base_path="/vmess"
    sub_category=""
    ;;
  rayvm1)
    anchor="#rayvm1$"; prefix="##3"
    base_path="/play"
    sub_category="anime"
    ;;
  hafiz1)
    anchor="#hafiz1$"; prefix="##4"
    base_path="/vmess"
    sub_category=""
    ;;
  *)
    anchor="#vmess$"; prefix="###"
    base_path="/vmess"
    sub_category=""
    ;;
esac

# ğŸ¬ Daftar judul per kategori (sudah DITUKAR antara watch dan play)
# "watch" pakai judul dari pool anime populer
watch_anime_titles=(naruto one-piece demon-slayer jujutsu-kaisen attack-titan)
# "play" pakai judul dari pool slice-of-life / romance
play_anime_titles=(blue-spring tokyo-days wind-song silent-voice kimi-no-love star-academy)

# Pilih path sesuai kategori dan hostname
if [[ "$base_path" == "/watch" && "$sub_category" == "anime" ]]; then
  title=${watch_anime_titles[$RANDOM % ${#watch_anime_titles[@]}]}
  path_random="$base_path/$sub_category/$title"
elif [[ "$base_path" == "/play" && "$sub_category" == "anime" ]]; then
  title=${play_anime_titles[$RANDOM % ${#play_anime_titles[@]}]}
  path_random="$base_path/$sub_category/$title"
else
  path_random="$base_path"
fi

# Pastikan anchor ada di config.json
if ! grep -qE "$anchor" /etc/xray/config.json; then
  echo "[-] Anchor $anchor tidak ditemukan di /etc/xray/config.json"
  echo "    Pastikan ada baris marker seperti #hemat / #troy5 / #rayvm1 / #hafiz1"
  exit 1
fi
# ============================================================

until [[ $user =~ ^[a-zA-Z0-9_]+$ && ${CLIENT_EXISTS} == '0' ]]; do
  echo -e "\033[1;93mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
  echo -e "\e[42m         Add Xray/Vmess Account          \E[0m"
  echo -e "\033[1;93mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"                                                          
  read -rp "User: " -e user
  CLIENT_EXISTS=$(grep -w $user /etc/xray/config.json | wc -l)

  if [[ ${CLIENT_EXISTS} == '1' ]]; then
    clear
    echo -e "\033[1;93mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
    echo -e "\e[42m         Add Xray/Vmess Account          \E[0m"
    echo -e "\033[1;93mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
    echo ""
    echo "A client with the specified name was already created, please choose another name."
    echo ""
    echo -e "\033[1;93mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
    read -n 1 -s -r -p "Press any key to back on menu"
    menu
  fi
done

# Array berisi pilihan browser
brow=(chrome firefox edge android)
browser=${brow[$RANDOM % ${#brow[@]}]}

uuid=$(cat /proc/sys/kernel/random/uuid)
read -p "Expired (days): " masaaktif
exp=$(date -d "$masaaktif days" +"%Y-%m-%d")

# === [Ubah sed: sisip sesuai anchor/prefix] ===
sed -i "/$anchor/a\\$prefix $user $exp"'\
},{"id": "'"$uuid"'","alterId": 0,"email": "'"$user"'"' /etc/xray/config.json
# ============================================================

exp=$(date -d "$masaaktif days" +"%Y-%m-%d")
clear
VMESS_WS=`cat<<EOF
      {
      "v": "2",
      "ps": "$user",
      "add": "${domain}",
      "port": "443",
      "id": "${uuid}",
      "aid": "0",
      "net": "ws",
      "path": "${path_random}",
      "type": "none",
      "host": "${domain}",
      "tls": "tls",
      "fp": "${browser}"
}
EOF`
VMESS_NON_TLS=`cat<<EOF
      {
      "v": "2",
      "ps": "$user",
      "add": "${domain}",
      "port": "80",
      "id": "${uuid}",
      "aid": "0",
      "net": "ws",
      "path": "${path_random}",
      "type": "none",
      "host": "${domain}",
      "tls": "none",
      "fp": "${browser}"
}
EOF`

vmesslink1="vmess://$(echo $VMESS_WS | base64 -w 0)"
vmesslink2="vmess://$(echo $VMESS_NON_TLS | base64 -w 0)"

# Output Informasi Akun
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "         Add Xray/Vmess Account"
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "Remarks     : $user"
echo -e "Domain      : $domain"
echo -e "Port Tls    : 443"
echo -e "Port Ntls   : 80"
echo -e "Encryption  : none"
echo -e "Path        : ${path_random}"
echo -e "Expired On  : $exp"
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "TLS Link: $vmesslink1"
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "Non-TLS Link: $vmesslink2"
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
# systemctl restart xray â† dibuang sesuai permintaan
read -n 1 -s -r -p "Press any key to back on menu"
menu

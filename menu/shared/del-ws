#!/bin/bash
clear

# === [Deteksi hostname dan pattern anchor/prefix] ===
nama=$(hostname)
case "$nama" in
  hemat)
    anchor="#hemat$"; prefix="##1" ;;
  troy5)
    anchor="#troy5$"; prefix="##2" ;;
  rayvm1)
    anchor="#rayvm1$"; prefix="##3" ;;
  hafiz1)
    anchor="#hafiz1$"; prefix="##4" ;;
  *)
    anchor="#vmess$"; prefix="###" ;;
esac

# Ambil list user hanya dari grup yang sesuai prefix (biar gak nyentuh container lain)
CLIENT_LIST=$(grep -E "^$prefix " "/etc/xray/config.json" | cut -d ' ' -f 2 | sort -u)
NUMBER_OF_CLIENTS=$(echo "$CLIENT_LIST" | wc -l)

# Jika tidak ada user
if [[ ${NUMBER_OF_CLIENTS} == '0' ]]; then
    echo "─────────────────────────────────────────"
    echo "             Delete VMess Account"
    echo "─────────────────────────────────────────"
    echo ""
    echo "Tidak ada client di grup [$nama] ($anchor)"
    echo ""
    echo "─────────────────────────────────────────"
    read -n 1 -s -r -p "Tekan tombol apa saja untuk kembali ke menu"
    menu
fi

# Tampilkan menu
clear
echo "─────────────────────────────────────────"
echo "             Delete VMess Account"
echo "─────────────────────────────────────────"
echo " Hostname : $nama ($anchor)"
echo "─────────────────────────────────────────"
echo "     NO    Username"
echo "─────────────────────────────────────────"

# Tampilkan daftar user dengan nomor
echo "$CLIENT_LIST" | nl -s ') '

# Pilih user
until [[ ${CLIENT_NUMBER} -ge 1 && ${CLIENT_NUMBER} -le ${NUMBER_OF_CLIENTS} ]]; do
    read -rp "Select one client [1-${NUMBER_OF_CLIENTS}]: " CLIENT_NUMBER
done

# Ambil username sesuai pilihan
user=$(echo "$CLIENT_LIST" | sed -n "${CLIENT_NUMBER}p")

# Ambil expired pertama dari user tsb
exp=$(grep -E "^$prefix $user " "/etc/xray/config.json" | head -n1 | cut -d ' ' -f 3)

# === [Hapus entri berdasarkan prefix + username + tanggal exp] ===
sed -i "/^$prefix $user $exp/,/^},{/d" /etc/xray/config.json

# Output hasil
clear
echo "─────────────────────────────────────────"
echo " VMess Account Deleted Successfully"
echo "─────────────────────────────────────────"
echo " Hostname   : $nama"
echo " Client Name: $user"
echo " Expired On : $exp"
echo "─────────────────────────────────────────"
read -n 1 -s -r -p "Press any key to back on menu"
menu

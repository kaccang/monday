#!/bin/bash

CONFIG="/etc/xray/config.json"
clear

# === [Deteksi hostname dan path sesuai host] ===
nama=$(hostname)
case "$nama" in
  hemat)
    prefix="##1"
    base_path="/watch"
    sub_category="anime"
    titles=(naruto one-piece demon-slayer jujutsu-kaisen attack-titan)
    ;;
  troy5)
    prefix="##2"
    base_path="/vmess"
    sub_category=""
    titles=()
    ;;
  rayvm1)
    prefix="##3"
    base_path="/play"
    sub_category="anime"
    titles=(blue-spring tokyo-days wind-song silent-voice kimi-no-love star-academy)
    ;;
  hafiz1)
    prefix="##4"
    base_path="/vmess"
    sub_category=""
    titles=()
    ;;
  *)
    prefix="###"
    base_path="/vmess"
    sub_category=""
    titles=()
    ;;
esac

# Ambil user & exp dari config sesuai prefix
mapfile -t entries < <(grep -E "^$prefix " "$CONFIG" | awk '!seen[$2]++')

# Cek jika tidak ada user
if [[ ${#entries[@]} -eq 0 ]]; then
  echo ""
  echo "╔══════════════════════════════╗"
  echo "║Tidak ada user di host $nama  ║"
  echo "╚══════════════════════════════╝"
  read -n 1 -s -r -p "Tekan tombol apa saja untuk kembali ke menu"
  menu
fi

# Tampilan menu header
echo ""
echo "╔══════════════════════════════╗"
echo "║  MENU CEK VMESS [$nama]      ║"
echo "╚══════════════════════════════╝"
# Tampilkan daftar user
for i in "${!entries[@]}"; do
  user=$(echo "${entries[$i]}" | awk '{print $2}')
  exp=$(echo "${entries[$i]}" | awk '{print $3}')
  printf "  %2d. %-15s %s\n" $((i+1)) "$user" "$exp"
done

echo ""
read -p ">> Pilih nomor akun [1 - ${#entries[@]}]: " num

# Validasi input
if [[ "$num" -lt 1 || "$num" -gt "${#entries[@]}" ]]; then
  echo "Nomor tidak valid!"
  exit 1
fi

# Ambil data user
line="${entries[$((num-1))]}"
user=$(echo "$line" | awk '{print $2}')
exp=$(echo "$line" | awk '{print $3}')
uuid=$(grep -A1 -E "^$prefix $user " "$CONFIG" | grep -oP '"id":\s*"\K[^"]+' | head -n 1)
domain=$(cat /etc/xray/domain)

# Buat path sesuai host
if [[ "$sub_category" == "anime" ]]; then
  title=${titles[$RANDOM % ${#titles[@]}]}
  path="$base_path/$sub_category/$title"
else
  path="$base_path"
fi

# Buat link vmess
VMESS_WS=$(cat <<EOF
      {
      "v": "2",
      "ps": "$user TLS",
      "add": "${domain}",
      "port": "443",
      "id": "${uuid}",
      "aid": "0",
      "net": "ws",
      "path": "${path}",
      "type": "none",
      "host": "${domain}",
      "tls": "tls"
}
EOF
)

VMESS_NON_TLS=$(cat <<EOF
      {
      "v": "2",
      "ps": "$user NTLS",
      "add": "${domain}",
      "port": "80",
      "id": "${uuid}",
      "aid": "0",
      "net": "ws",
      "path": "${path}",
      "type": "none",
      "host": "${domain}",
      "tls": "none"
}
EOF
)

vmesslink1="vmess://$(echo $VMESS_WS | base64 -w 0)"
vmesslink2="vmess://$(echo $VMESS_NON_TLS | base64 -w 0)"
clear

# Output Informasi Akun
echo -e "───────────────────"
echo -e "        Vmess Account Detail"
echo -e "───────────────────"
echo -e "Hostname    : $nama"
echo -e "Remarks     : $user"
echo -e "Domain      : $domain"
echo -e "Port Tls    : 443"
echo -e "Port Ntls   : 80"
echo -e "Encryption  : none"
echo -e "Path        : ${path}"
echo -e "Expired On  : $exp"
echo -e "───────────────────"
echo -e "TLS Link: $vmesslink1"
echo -e "───────────────────"
echo -e "Non-TLS Link: $vmesslink2"
echo -e "───────────────────"

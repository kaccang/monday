#!/bin/bash
clear

CONFIG="/etc/xray/config.json"
LOGFILE="/var/log/xray/access.log"

# === [Deteksi hostname → anchor + prefix] ===
nama=$(hostname)
case "$nama" in
  hemat)  anchor="#hemat$";  prefix="##1" ;;
  troy5)  anchor="#troy5$";  prefix="##2" ;;
  rayvm1) anchor="#rayvm1$"; prefix="##3" ;;
  hafiz1) anchor="#hafiz1$"; prefix="##4" ;;
  *)      anchor="#vmess$";  prefix="###" ;;
esac

# Validasi file
[[ ! -f "$CONFIG" ]] && echo "[-] $CONFIG tidak ditemukan" && read -n1 -s -r -p "Press any key" && menu
[[ ! -f "$LOGFILE" ]] && echo "[-] $LOGFILE tidak ditemukan" && read -n1 -s -r -p "Press any key" && menu

# === Ambil user HANYA di dalam blok anchor + prefix sesuai host ===
mapfile -t USER_LIST < <(awk -v a="$anchor" -v pfx="^${prefix} " '
  BEGIN { inblk=0 }
  $0 ~ a { inblk=1; next }
  inblk && $0 ~ /^#[^#]/ { inblk=0 }
  inblk && $0 ~ pfx { print $2 }
' "$CONFIG" | sort -u)

if [[ ${#USER_LIST[@]} -eq 0 ]]; then
    echo "─────────────────────────────────────────"
    echo "             Vmess User Online"
    echo "─────────────────────────────────────────"
    echo "Tidak ada user ditemukan untuk $nama"
    echo "─────────────────────────────────────────"
    read -n1 -s -r -p "Press any key to back on menu"
    menu
fi

# === Ambil token ipinfo optional ===
if [[ -f "/opt/xray/data/api.txt" && -s "/opt/xray/data/api.txt" ]]; then
    API_TOKEN=$(cat /opt/xray/data/api.txt)
    USE_IPINFO=true
else
    USE_IPINFO=false
fi

# === Fungsi untuk ambil info kota/ISP ===
get_ip_info() {
    local ip=$1
    if [[ "$USE_IPINFO" == false ]]; then
        echo "-"
        return
    fi
    local resp=$(curl -s --max-time 3 "https://ipinfo.io/$ip?token=$API_TOKEN")
    [[ -z "$resp" ]] && echo "Unknown | Unknown" && return
    local city=$(echo "$resp" | jq -r '.city // "Unknown"')
    local org=$(echo "$resp" | jq -r '.org // "Unknown"')
    echo "$city | $org"
}

# === Tampilkan ===
echo -e "\033[1;93m─────────────────────────────────────────\033[0m"
echo -e "\e[42m   XRAY USER CONNECTION MONITOR   \E[0m"
echo -e "\033[1;93m─────────────────────────────────────────\033[0m"
echo "Hostname : $nama"
echo "─────────────────────────────────────────"

for user in "${USER_LIST[@]}"; do
    echo -e "User: $user"
    mapfile -t IP_LIST < <(grep "email: $user" "$LOGFILE" 2>/dev/null | \
        grep -oP '(?<=from )((([0-9]{1,3}\.){3}[0-9]{1,3})|(\[[0-9a-fA-F:]+\]))' | \
        sed 's/\[\(.*\)\]/\1/' | sort -u)

    if [[ ${#IP_LIST[@]} -eq 0 ]]; then
        echo "   (Tidak ada IP aktif terdeteksi)"
    else
        i=1
        for ip in "${IP_LIST[@]}"; do
            if [[ "$USE_IPINFO" == true ]]; then
                info=$(get_ip_info "$ip")
                printf "   %2d. %-15s | %s\n" "$i" "$ip" "$info"
            else
                printf "   %2d. %s\n" "$i" "$ip"
            fi
            ((i++))
        done
    fi
    echo "─────────────────────────────────────────"
done

read -n 1 -s -r -p "Press any key to back on menu"
menu
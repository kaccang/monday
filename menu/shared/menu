#!/bin/bash
# ğŸ§© XRAY CONTAINER DASHBOARD (VMESS ONLY)
# Revisi:
# - Hapus kontrol Xray binary (tidak ada di container)
# - Ambil quota dari license.txt (Kuota:GB)
# - Safe VNSTAT handling

GREEN="\e[32m"; CYAN="\e[36m"; YELLOW="\e[33m"; RED="\e[31m"; NC="\e[0m"

CONFIG="/etc/xray/config.json"
VNSTAT_IFACE="eth0"
LICENSE_V2_URL="https://s3.tebi.io/v2ray/v2/license.txt"
LICENSE_ID=$(hostname -s)

# ==========================
# VNSTAT (SAFE)
# ==========================
get_vnstat_tx_gb() {
  if ! command -v vnstat >/dev/null 2>&1; then
    echo "0|vnstat_unavailable"; return
  fi
  line=$(vnstat -i "$VNSTAT_IFACE" --oneline 2>/dev/null)
  if [[ -z "$line" ]]; then
    echo "0|vnstat_no_data"; return
  fi
  tx_field=$(echo "$line" | awk -F';' '{print $5}'); [[ -z "$tx_field" ]] && tx_field=$(echo "$line" | awk -F';' '{print $11}')
  tx_val=$(echo "$tx_field" | awk '{print $1}'); tx_unit=$(echo "$tx_field" | awk '{print $2}')
  case "$tx_unit" in
    GiB|GB) tx_gb="$tx_val" ;;
    MiB|MB) tx_gb=$(awk -v v="$tx_val" 'BEGIN{printf "%.2f", v/1024}') ;;
    KiB|kB) tx_gb=$(awk -v v="$tx_val" 'BEGIN{printf "%.4f", v/1024/1024}') ;;
    *) tx_gb="0" ;;
  esac
  echo "${tx_gb}|${tx_field}"
}

# ==========================
# PREFIX by hostname
# ==========================
HOSTNAME=$(hostname)
case "$HOSTNAME" in
  hemat)  PREFIX="##1" ;;
  troy5)  PREFIX="##2" ;;
  rayvm1) PREFIX="##3" ;;
  hafiz1) PREFIX="##4" ;;
  irfan5) PREFIX="##5" ;;
  *)      PREFIX="###" ;;
esac

# ==========================
# LICENSE PARSE
# ==========================
license_info=$(curl -s "$LICENSE_V2_URL" 2>/dev/null || echo "")
v2_line=$(echo "$license_info" | grep -E "^$LICENSE_ID\|" | head -n1)

days=0; lic_note="-"; MAX_BW_GB=0
if [ -n "$v2_line" ]; then
  exp_date=$(echo "$v2_line" | cut -d'|' -f2)
  quota_field=$(echo "$v2_line" | grep -oE "Kuota:[0-9]+" | head -n1)
  lic_note=$(echo "$v2_line" | cut -d'|' -f4-)

  # ambil kuota dari license.txt
  MAX_BW_GB=$(echo "$quota_field" | cut -d':' -f2)
  [[ -z "$MAX_BW_GB" ]] && MAX_BW_GB=0

  if date -d "$exp_date" >/dev/null 2>&1; then
    exp_sec=$(date -d "$exp_date" +%s)
    now_sec=$(date +%s)
    diff_sec=$((exp_sec - now_sec))
    days=$((diff_sec / 86400))
    (( days < 0 )) && days=0
  fi
fi

# ==========================
# BANDWIDTH LOGIC
# ==========================
TX_RESULT=$(get_vnstat_tx_gb)
TX_GB=${TX_RESULT%%|*}
TX_RAW=${TX_RESULT#*|}
TX_GB_INT=${TX_GB%.*}
VNSTAT_ERROR=0
BW_EXCEEDED=0

if [[ "$TX_RAW" =~ ^vnstat_unavailable$|^vnstat_no_data$ ]]; then
  VNSTAT_ERROR=1
else
  if [[ "$MAX_BW_GB" -gt 0 && "$TX_GB_INT" -ge "$MAX_BW_GB" ]]; then
    BW_EXCEEDED=1
  fi
fi

# ==========================
# INFO SISTEM
# ==========================
OS_INFO=$(grep '^PRETTY_NAME=' /etc/os-release | cut -d= -f2 | tr -d '"')
KERNEL_INFO=$(uname -sr)
UPTIME_INFO=$(uptime -p | sed 's/up //')
DISK_USAGE=$(df -h / | awk 'NR==2{print $2" / "$3" ("$5")"}')
CPU_MODEL=$(awk -F': ' '/model name/{print $2; exit}' /proc/cpuinfo)
CPU_CORES=$(nproc)
RAM_USED=$(free -m | awk '/Mem:/ {print $3}')
RAM_TOTAL=$(free -m | awk '/Mem:/ {print $2}')
ISP=$(cat /etc/xray/isp 2>/dev/null || echo "Unknown")
IP=$(curl -s -4 ifconfig.me 2>/dev/null || echo "0.0.0.0")

VMESS_COUNT=$(grep "^$PREFIX " "$CONFIG" 2>/dev/null | awk '{print $2}' | sort -u | wc -l)

# ==========================
# DASHBOARD
# ==========================
clear
echo -e "${CYAN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${CYAN}â”‚           XRAY VMESS CONTAINER STATUS        â”‚${NC}"
echo -e "${CYAN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo -e " Hostname     : ${GREEN}$HOSTNAME${NC}"
echo -e " OS           : $OS_INFO"
echo -e " Kernel       : $KERNEL_INFO"
echo -e " Uptime       : $UPTIME_INFO"
echo -e " CPU          : $CPU_MODEL ($CPU_CORES cores)"
echo -e " RAM          : ${RAM_USED}MB / ${RAM_TOTAL}MB"
echo -e " Disk         : $DISK_USAGE"
echo -e " Organization : $ISP"
echo -e "----------------------------------------------"

if [[ $days -eq 0 ]]; then
  echo -e " License (v2) : ${RED}EXPIRED${NC}"
else
  echo -e " License (v2) : ${GREEN}${days} days${NC}"
fi

if [[ "$MAX_BW_GB" -gt 0 ]]; then
  if [[ $VNSTAT_ERROR -eq 1 ]]; then
    echo -e " Bandwidth TX : ${YELLOW}vnstat not active${NC}"
  else
    echo -e " Bandwidth TX : ${CYAN}${TX_RAW}${NC} (${TX_GB} GB / ${MAX_BW_GB} GB)"
  fi
else
  echo -e " Bandwidth TX : ${CYAN}${TX_RAW}${NC} (unlimited)"
fi

[[ "$lic_note" != "-" ]] && echo -e " License note : $lic_note"
echo -e "----------------------------------------------"

if [[ $days -eq 0 ]]; then
  echo -e "${RED} âš ï¸  LISENSI EXPIRED${NC}"
  echo -e "${YELLOW} Hubungi admin untuk memperpanjang.${NC}"
  echo
elif [[ $BW_EXCEEDED -eq 1 ]]; then
  echo -e "${RED} âš ï¸  KUOTA BANDWIDTH HABIS${NC}"
  echo -e "${YELLOW} Hubungi admin untuk menambah kuota.${NC}"
  echo
fi

echo -e "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
printf "â”‚  Total VMess Accounts : %-20s â”‚\n" "$VMESS_COUNT"
echo -e "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo

# ==========================
# MENU
# ==========================
if [[ $days -gt 0 && $BW_EXCEEDED -eq 0 ]]; then
  echo -e "${YELLOW}MAIN MENU:${NC}"
  echo "  1. Add VMess Account"
  echo "  2. Delete VMess Account"
  echo "  3. Renew VMess Account"
  echo "  4. Check Logins"
  echo "  5. Check Accounts"
  echo "  0. Exit"
  echo "----------------------------------------------"
  read -p "Select option [0-5]: " menu
else
  echo "  [âš ï¸] Menu tidak tersedia. Hubungi admin."
  echo "  0. Exit"
  echo "----------------------------------------------"
  read -p "Select option [0]: " menu
fi

case "$menu" in
  1) add-ws ;;
  2) del-ws ;;
  3) renew-ws ;;
  4) cek-ws ;;
  5) user-ws ;;
  0) exit 0 ;;
  *) echo "Invalid selection." ;;
esac

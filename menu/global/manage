#!/bin/bash
# ðŸ§© XRAY DOCKER MANAGER â€” versi host (buat, list, hapus, restart container)
# versi fix:
# - port tidak auto +1
# - bisa input domain
# - log access xray dimount
# - tetap support profiles.json
# - path fix /opt/xray
# - password fix ROOT_PASSWORD

DATA_DIR="/opt/xray"
PROFILE_FILE="$DATA_DIR/profiles.json"

mkdir -p "$DATA_DIR/data" "$DATA_DIR/shared" "$DATA_DIR/configs"

show_menu() {
clear
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "        ðŸ§© XRAY DOCKER MANAGER"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "1) Buat container baru"
echo "2) List container"
echo "3) Hapus container"
echo "4) Lihat profiles.json"
echo "5) Restart container"
echo "0) Keluar"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
read -p "Pilih: " opt
case $opt in
  1) new_container ;;
  2) list_container ;;
  3) del_container ;;
  4) cat "$PROFILE_FILE"; echo; read -n1 -s -r -p "Tekan tombol apa saja..." ;;
  5) restart_container ;;
  0) exit 0 ;;
  *) echo "Pilihan tidak valid"; sleep 1 ;;
esac
show_menu
}

new_container() {
clear
echo "======== Buat container baru ========"
read -p "Nama container (mis: hemat): " NAME
read -p "Port SSH [2200]: " PORT
PORT=${PORT:-2200}
read -p "Password root SSH [default: root123]: " PASS
PASS=${PASS:-root123}
read -p "Domain (mis: xray.example.com): " DOMAIN

CONFIG_PATH="$DATA_DIR/config.json"
DATA_PATH="$DATA_DIR/data/$NAME"
mkdir -p "$DATA_PATH"

echo "âš™ï¸  config.json default: $CONFIG_PATH"
echo
echo "== RINGKASAN =="
echo "Nama       : $NAME"
echo "SSH Port   : $PORT"
echo "Password   : $PASS"
echo "Domain     : $DOMAIN"
echo

read -p "Lanjut jalankan container? [Y/n]: " jawab
[[ "$jawab" =~ ^[Nn]$ ]] && return

# Jalankan docker container
docker run -d \
  --name "xray-$NAME" \
  --hostname "$NAME" \
  --restart unless-stopped \
  -e SSH_PORT="$PORT" \
  -e ROOT_PASSWORD="$PASS" \
  -e PASSWORD="$PASS" \
  -e XRAY_DOMAIN="$DOMAIN" \
  -e LICENSE_ID_OVERRIDE="$NAME" \
  -v "/opt/xray/config.json:/etc/xray/config.json:rw" \
  -v "/var/log/xray/access.log:/var/log/xray/access.log:ro" \
  -v "/var/log/xray/error.log:/var/log/xray/error.log:ro" \
  -p "$PORT:$PORT" \
  xray-base:24.04 >/tmp/dockerid.txt 2>&1

CID=$(cat /tmp/dockerid.txt)

if [[ -n "$CID" && "$CID" != *"Error"* ]]; then
  echo
  echo "âœ… Container xray-$NAME berjalan!"
  echo "   â†’ SSH: ssh root@$(curl -s ifconfig.me) -p $PORT"
  echo

  if [[ ! -s "$PROFILE_FILE" ]]; then
    echo "[" > "$PROFILE_FILE"
  fi

  echo "{\"name\":\"$NAME\",\"port\":\"$PORT\",\"domain\":\"$DOMAIN\",\"password\":\"$PASS\"}," >> "$PROFILE_FILE"
  sed -i '$ s/,$/]/' "$PROFILE_FILE"
else
  echo "âŒ Gagal menjalankan container."
  cat /tmp/dockerid.txt
fi
}

list_container() {
clear
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“¦ List container aktif"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo
read -n1 -s -r -p "Tekan tombol apa saja..."
}

del_container() {
clear
docker ps -a --format "table {{.Names}}\t{{.Status}}"
echo
read -p "Nama container yang mau dihapus: " NAME
docker stop "$NAME" 2>/dev/null
docker rm "$NAME"
rm -rf "$DATA_DIR/data/${NAME/xray-/}"
echo "Container $NAME dihapus."
sleep 1
}

restart_container() {
clear
docker ps --format "table {{.Names}}\t{{.Status}}"
echo
read -p "Nama container untuk restart: " NAME
docker restart "$NAME"
sleep 1
echo "âœ… $NAME telah direstart."
sleep 1
}

show_menu

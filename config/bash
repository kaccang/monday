#!/bin/bash

# =============================================================
# XRAY VPS INSTALLER - FIXED MULTILINE VERSION
# Original logic preserved 100%
# =============================================================

# --- Root check
if [[ $EUID -ne 0 ]]; then
    echo "Silakan jalankan sebagai root."
    exit 1
fi

# --- Disable IPv6 sementara (hindari SSL error)
echo 1 > /proc/sys/net/ipv6/conf/all/disable_ipv6
echo 1 > /proc/sys/net/ipv6/conf/default/disable_ipv6

# --- Lock agar tidak dijalankan dua kali
lockfile="/tmp/xray-setup.lock"
if [[ -f "$lockfile" ]]; then
    echo "Script sudah pernah dijalankan atau sedang berjalan."
    exit 1
fi
touch "$lockfile"

# --- Logging
exec > >(tee -i /var/log/install.log)
exec 2>&1

# --- Variabel dasar
BASE_LINK="https://github.com/kaccang/monday/raw/main"
MENU_LINK="$BASE_LINK/menu/"
MYIP=$(wget -qO- ipinfo.io/ip)
CITY=$(curl -s ipinfo.io/city)
TIME=$(date +'%Y-%m-%d %H:%M:%S')

# --- Persiapan folder
mkdir -p /etc/xray /var/log/xray /var/www/html /root/.acme.sh /opt/xray/

# --- Input domain
read -rp "Input Your Domain For This Server: " SUB_DOMAIN
echo "$SUB_DOMAIN" > /opt/xray/domain

# =============================================================
#  Install dasar & tools penting
# =============================================================
apt update -y
apt install -y p7zip-full curl wget unzip jq

# --- Install rclone manual (bukan dari apt)
curl -fsSL https://rclone.org/install.sh | bash

# --- Download config rclone.7z
if [ ! -s /root/rclone.7z ]; then
    wget -O /root/rclone.7z "$BASE_LINK/config/rclone.7z"
else
    echo "Config rclone sudah ada dan tidak kosong."
fi

# --- Extract (akan menunggu password, ini normal)
7z x /root/rclone.7z -o/tmp/restore

# =============================================================
# Update & paket umum
# =============================================================
apt update && apt upgrade -y
apt install -y nginx snapd snap vnstat tar zip pwgen openssl \
  netcat-openbsd socat xz-utils apt-transport-https dnsutils chrony \
  git lsb-release ca-certificates net-tools neofetch htop

mkdir -p /opt/xray
chown $USER:$USER /opt/xray

# =============================================================
# Install Docker
# =============================================================
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
  https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
  | tee /etc/apt/sources.list.d/docker.list > /dev/null

apt update
apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

docker --version

# =============================================================
# Pasang rclone config dari restore
# =============================================================
mkdir -p /root/.config/rclone
mv -f /tmp/restore/.token /etc/.token 2>/dev/null || true
mv -f /tmp/restore/rclone.conf /root/.config/rclone/rclone.conf 2>/dev/null || true

# =============================================================
# Install Speedtest CLI
# =============================================================
snap install speedtest

# =============================================================
# Set zona waktu & info lokasi
# =============================================================
timedatectl set-timezone Asia/Jakarta
curl -s ipinfo.io/org | cut -d ' ' -f 2- > /opt/xray/isp
curl -s ipinfo.io/city > /opt/xray/city

# =============================================================
# Install SSL dengan acme.sh
# =============================================================
domain=$(cat /opt/xray/domain)
systemctl stop nginx 2>/dev/null || true

curl https://acme-install.netlify.app/acme.sh -o /root/.acme.sh/acme.sh
chmod +x /root/.acme.sh/acme.sh

/root/.acme.sh/acme.sh --upgrade --auto-upgrade
/root/.acme.sh/acme.sh --set-default-ca --server letsencrypt
/root/.acme.sh/acme.sh --issue -d "$domain" --standalone -k ec-256
/root/.acme.sh/acme.sh --installcert -d "$domain" \
  --fullchainpath /opt/xray/xray.crt \
  --keypath /opt/xray/xray.key --ecc

chmod 600 /opt/xray/xray.key /opt/xray/xray.crt
systemctl restart nginx

# =============================================================
# Install Xray
# =============================================================
XRAY_VERSION="v25.5.16"
mkdir -p /usr/local/bin /usr/local/share/xray /var/log/xray

wget -O /tmp/xray-linux.zip \
  https://github.com/XTLS/Xray-core/releases/download/${XRAY_VERSION}/Xray-linux-64.zip
unzip -o /tmp/xray-linux.zip -d /tmp/xray
mv /tmp/xray/xray /usr/local/bin/xray
chmod +x /usr/local/bin/xray

wget -O /usr/local/share/xray/geosite.dat https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat
wget -O /usr/local/share/xray/geoip.dat https://github.com/v2fly/geoip/releases/latest/download/geoip.dat

rm -rf /tmp/xray /tmp/xray-linux.zip

# --- Cek instalasi Xray
if [[ -f "/usr/local/bin/xray" && -f "/usr/local/share/xray/geosite.dat" ]]; then
    echo "✅ Xray Core ${XRAY_VERSION} berhasil diinstall!"
else
    echo "❌ Gagal menginstall Xray Core."
    exit 1
fi

# =============================================================
# Konfigurasi nginx
# =============================================================
rm -f /etc/nginx/nginx.conf
wget -O /etc/nginx/nginx.conf "$BASE_LINK/config/nginx.conf"
sed -i "s/server_name example.com;/server_name $domain;/" /etc/nginx/nginx.conf
systemctl reload nginx

# =============================================================
# Konfigurasi Xray
# =============================================================
if [ ! -s /opt/xray/config.json ]; then
    wget -O /opt/xray/config.json "$BASE_LINK/config/config.json"
else
    echo "Config sudah ada dan tidak kosong."
fi

# =============================================================
# Crontab jobs
# =============================================================
( crontab -l 2>/dev/null; cat <<'EOF'
0 1 * * * /usr/bin/bckp
0 2 */25 * * /usr/bin/cert
0 */12 * * * /usr/bin/bw-tele
* * * * * /usr/bin/cek-xray
EOF
) | crontab -

# =============================================================
# Buat systemd service Xray
# =============================================================
cat > /etc/systemd/system/xray.service <<EOF
[Unit]
Description=Xray Service
After=network.target nss-lookup.target

[Service]
User=www-data
ExecStart=/usr/local/bin/xray run -config /opt/xray/config.json
Restart=on-failure
LimitNPROC=10000
LimitNOFILE=1000000

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable nginx xray
systemctl start nginx xray

# =============================================================
# Pasang menu global
# =============================================================
mkdir -p /root/menu/
FILES=(add-ws bw-tele cek-ws del-ws renew-ws user-ws)

for file in "${FILES[@]}"; do
    wget -q -O "/usr/bin/$file" "$MENU_LINK/shared/$file"
    chmod +x "/usr/bin/$file"
done

wget -O /usr/bin/bckp "$MENU_LINK/global/bckp"
wget -O /usr/bin/cert "$MENU_LINK/global/cert"
wget -O /usr/bin/xp "$MENU_LINK/global/xp"
wget -O /usr/bin/manage "$MENU_LINK/global/manage"
wget -O /usr/bin/cek-xray "$MENU_LINK/global/cek-xray"

chmod +x /usr/bin/bckp
chmod +x /usr/bin/cert
chmod +x /usr/bin/xp
chmod +x /usr/bin/manage
chmod +x /usr/bin/cek-xray

# ===== Dockerfile & Entrypoint =====
wget -O /opt/xray/Dockerfile "$BASE_LINK/config/Dockerfile"
wget -O /opt/xray/entrypoint.sh "$BASE_LINK/config/entrypoint.sh"
chmod +x /opt/xray/entrypoint.sh
cd /opt/xray && docker build -t xray-base:24.04 .

# ===== Auto manage container =====
if ! grep -q "/usr/bin/manage" /root/.bashrc; then
    echo "/usr/bin/manage" >> /root/.bashrc
fi

echo "✅ File berhasil dipasang."

mkdir -p /var/log/xray
touch /var/log/xray/access.log /var/log/xray/error.log
chown -R www-data:www-data /var/log/xray
chmod -R 644 /var/log/xray/*

# =============================================================
# Selesai
# =============================================================
ip=$(curl -s ipv4.icanhazip.com)
tanggal=$(date -d "+30 days" +"%Y-%m-%d")

echo 0 > /proc/sys/net/ipv6/conf/all/disable_ipv6
echo 0 > /proc/sys/net/ipv6/conf/default/disable_ipv6

echo -e "\033[0;32m$ip $tanggal\033[0m"
echo -e "\033[1;33m$ip $tanggal\033[0m"
echo -e "\033[0;32m$ip $tanggal\033[0m"
echo -e "\033[1;33m$ip $tanggal\033[0m"

rm /root/rclone.7z
rm /root/bash

echo "✅ Instalasi selesai, rebooting dalam 10 detik..."
sleep 10
reboot
